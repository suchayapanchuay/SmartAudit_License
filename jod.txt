# === sys.path: ให้มองเห็น project-root/shared ก่อน import อื่นๆ ===
import os, sys, importlib.util
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(CURRENT_DIR)
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)
# =====================================================================

from fastapi import FastAPI, APIRouter
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.routing import APIRoute

from database import Base, engine

# ======= MODELS (ของคุณเดิม) =======
from models.activity_log import ActivityLog  # ถ้ามี
from models.product import Product
from models.customer import Customer
from models.order import Order

# ======= ROUTES (ของคุณเดิม) =======
from routes import license_check, auth_route, license_route, dashboard

# ======= ROUTES (ใหม่) =======
from routes import order_route
from routes import admin_notify

# --- DEBUG: พิสูจน์ว่า Python หา routes.trial_requests เจอไฟล์ไหน ---
spec = importlib.util.find_spec("routes.trial_requests")
print("[BOOT] routes.trial_requests origin:", spec.origin if spec else "NOT FOUND")

# ถ้า NOT FOUND ตรงนี้ให้หยุดก่อนเลย (อย่าพยายาม import ต่อ), แต่เพื่อเดโม เราจะลอง import:
try:
    from routes.trial_requests import router as trials_router
    print("[BOOT] trials_router imported OK")
    print("[BOOT] trials_router routes:",
          [(r.path, r.methods) for r in getattr(trials_router, "routes", [])])
except Exception as e:
    print("[BOOT] import routes.trial_requests FAILED:", repr(e))
    trials_router = APIRouter()  # สร้างว่าง ๆ กันแอปล้ม

# --- PROBE: สร้าง router โปรบทดสอบ include_router ---
probe = APIRouter()
@probe.get("/__probe")
async def __probe():
    return {"ok": True}

app = FastAPI(
    title="SmartClick License Server",
    description="API สำหรับตรวจสอบ license และจัดการ auth สำหรับ SmartAudit",
    version="1.0.0",
)

# สร้างตารางทั้งหมด (หลัง import models ด้านบน)
Base.metadata.create_all(bind=engine)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "http://localhost:5173",
        "http://localhost:4173",
        "https://www.smartclick.co.th",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/", response_class=HTMLResponse)
def root():
    return """
    <html>
        <head><title>SmartAudit License Server</title></head>
        <body>
            <h1>SmartAudit License Server</h1>
            <p><a href="/docs" target="_blank">Swagger API Docs</a></p>
            <p><a href="/api/check_license" target="_blank">ตรวจสอบ License Key</a></p>
            <p><a href="/api/dashboard" target="_blank">ดูข้อมูล Dashboard (JSON)</a></p>
        </body>
    </html>
    """

@app.get("/health")
def health_check():
    return {"status": "ok"}

# ======= Include Routers =======
app.include_router(license_check.router, prefix="/api", tags=["License"])
app.include_router(license_route.router,  prefix="/api", tags=["License"])
app.include_router(auth_route.router,     prefix="/api", tags=["Auth"])
app.include_router(dashboard.router,      prefix="/api", tags=["Dashboard"])

app.include_router(order_route.router,    prefix="/api", tags=["Orders"])
app.include_router(admin_notify.router,   prefix="/api", tags=["AdminNotify"])

# PROBE router (ต้องเห็นแน่ๆ ถ้า include_router ทำงานถูก)
app.include_router(probe,                 prefix="/api")  # => /api/__probe

# Trials router (ถ้า import สำเร็จและมี endpoint จะโผล่)
app.include_router(trials_router,         prefix="/api")  # => /api/trial-requests

# Static files
if os.path.isdir("static"):
    app.mount("/static", StaticFiles(directory="static"), name="static")

# Debug: รายการเส้นทางตอนสตาร์ต
@app.on_event("startup")
async def _print_routes_on_startup():
    print("=== ROUTES ON START === (cwd:", os.getcwd(), ") (main file:", __file__, ")")
    for r in app.routes:
        if isinstance(r, APIRoute):
            print(" -", r.path, r.methods)
